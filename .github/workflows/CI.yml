name: CI
on:
  workflow_dispatch:
  pull_request:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: ðŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ èŽ·å–æœ€æ–° tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: ðŸ¹ å®‰è£… Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'  # æŒ‡å®š Go ç‰ˆæœ¬ï¼Œä¿æŒä¸€è‡´

      - name: ðŸ“ ç”Ÿæˆè‡ªè¿°æ–‡ä»¶
        run: go run .github/scripts/generate_project_files.go

      - name: ðŸ” è®¾ç½® GPG å¯†é’¥
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: ðŸ·ï¸ æ›´æ–°æ ‡ç­¾
        run: |
          git config user.name github-actions
          git config user.email "${{ secrets.COMMIT_EMAIL }}"
          git add .
          git commit -S -m "è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶ [skip ci]"
          git push origin HEAD:main
          git tag -d ${{ github.ref_name }} || true
          git push origin :refs/tags/${{ github.ref_name }} || true
          git tag -s ${{ github.ref_name }} -m "Release ${{ github.ref_name }}"
          git push origin ${{ github.ref_name }}
        # env:
          # COMMIT_EMAIL: ${{ secrets.COMMIT_EMAIL }}

      - name: ðŸš€ å‘å¸ƒ
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: ðŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¹ å®‰è£… Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: ðŸº å…‹éš† Homebrew ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: brewforge/homebrew-chinese
          path: homebrew-chinese
          token: ${{ secrets.HOMEBREW_TOKEN }}

      - name: ðŸ“ ç”Ÿæˆé…æ–¹æ•°æ®
        id: generate_data
        run: |
          go run .github/scripts/deliver_ruby_config.go > formula_data.json
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: ðŸ“¥ ä¸‹è½½æºç åŒ…
        run: |
          curl -L -o source.tar.gz https://github.com/Mrered/Gobin/archive/refs/tags/$VERSION.tar.gz
          echo "SHA256=$(sha256sum source.tar.gz | cut -d ' ' -f 1)" >> $GITHUB_ENV

      - name: ðŸ”¨ ç”Ÿæˆé…æ–¹æ–‡ä»¶
        run: |
          while IFS= read -r project; do
            name=$(echo $project | jq -r '.project')
            desc=$(echo $project | jq -r '.description')
            capitalized_name=$(echo ${name^})
            cat > "homebrew-chinese/Formula/${name}.rb" << EOL
          class ${capitalized_name} < Formula
            desc "${desc}"
            homepage "https://github.com/Mrered/Gobin"
            url "https://github.com/Mrered/Gobin/archive/refs/tags/${VERSION}.tar.gz"
            sha256 "${SHA256}"
            license "MIT"
            head "https://github.com/Mrered/Gobin.git", branch: "main"

            depends_on "go" => :build

            def install
              system "go", "build", *std_go_args(ldflags: "-s -w"), "./cmd/${name}"
            end

            test do
              system bin/"${name}", "-v"
            end
          end
          EOL
          done < <(jq -c '.[]' formula_data.json)

      - name: ðŸ”„ åˆ›å»º Pull Request
        run: |
          cd homebrew-chinese
          git config user.name github-actions
          git config user.email "${{ secrets.COMMIT_EMAIL }}"
          git add Formula/*.rb
          git commit -m "Gobin ${VERSION}"
          git push origin HEAD:gobin-${VERSION}
          gh pr create \
            --title "Gobin ${VERSION}" \
            --body "æ›´æ–° Gobin é…æ–¹åˆ°ç‰ˆæœ¬ ${VERSION}" \
            --base main \
            --head gobin-${VERSION}
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}
